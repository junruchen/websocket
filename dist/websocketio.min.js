!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e():"function"==typeof define&&define.amd?define(e):t.WebSocketIO=e()}(this,function(){"use strict";var t="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},e=function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")},n=function(){function t(t,e){for(var n=0;n<e.length;n++){var o=e[n];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(t,o.key,o)}}return function(e,n,o){return n&&t(e.prototype,n),o&&t(e,o),e}}(),o=function(t,e){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!e||"object"!=typeof e&&"function"!=typeof e?t:e},i=function(t){if(Array.isArray(t)){for(var e=0,n=Array(t.length);e<t.length;e++)n[e]=t[e];return n}return Array.from(t)},r=function(){function t(n){e(this,t),this._events={},this._ctx=n}return n(t,[{key:"on",value:function(t,e,n){return u(this,t,e,n,!1)}},{key:"once",value:function(t,e,n){return u(this,t,e,n,!0)}},{key:"off",value:function(t,e,n){var o=c(this,t,e,n);for(var i in o){var r=this._events[i];o[i].slice().forEach(function(t){r.splice(r.indexOf(t),1)})}return this}},{key:"pause",value:function(t,e,n){return s(this,t,e,n,!0)}},{key:"resume",value:function(t,e,n){return s(this,t,e,n,!1)}},{key:"emit",value:function(t){var e=this;if(!t||"string"!=typeof t)return this;for(var n=arguments.length,o=[],i=1;i<n;)o.push(arguments[i++]);return t.split(/\s+/).forEach(function(t){t&&e._events[t]&&e._events[t].slice().forEach(function(n){n.once?(n.cb.apply(n.ctx,o),e.off(t,n.cb,n.ctx)):n.pause||n.cb.apply(n.ctx,o)})}),this}}]),t}();function c(t,e,n,o){var i={};if(e)e.split(/\s+/).forEach(function(e){e&&t._events[e]&&(i[e]=t._events[e])});else for(var r in t._events)i[r]=t._events[r];var c=Object.keys(i);return 0===c.length?i:(n&&"function"==typeof n&&c.forEach(function(t){i[t]=i[t].filter(function(t){return t.cb===n})}),o&&c.forEach(function(t){i[t]=i[t].filter(function(t){return t.ctx===o})}),i)}function s(t,e,n,o,i){var r=c(t,e,n,o);for(var s in r)r[s].forEach(function(t){t.pause=i});return t}function u(t,e,n,o,i){return e&&"function"==typeof n&&"string"==typeof e?(e.split(/\s+/).forEach(function(e){var r=t._events[e]||[];r.push({cb:n,ctx:o||t._ctx,pause:!1,once:i}),t._events[e]=r}),t):t}var a={url:null,protocols:null,debug:!1,automaticOpen:!0,automaticReconnect:!0,reconnectInterval:1e3,maxReconnectInterval:3e4,reconnectDecay:1.5,timeoutInterval:2e3,maxReconnectAttempts:null,binaryType:"blob"},f=function(t){function i(t,n){var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};e(this,i);var c=o(this,(i.__proto__||Object.getPrototypeOf(i)).call(this));return y(n)&&(r=n,n=null),c.setConfig(r),c.url=t,c.protocols=n,c.protocol=null,c.io=null,c.forcedClose=!1,c.active=!0,c.reconnectAttempts=0,c.polls=[],!0===c.automaticOpen&&c.open(!1),c}return function(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):t.__proto__=e)}(i,r),n(i,[{key:"setConfig",value:function(t){if(y(t))for(var e in a)void 0!==t[e]?this[e]=t[e]:null==this[e]&&(this[e]=a[e])}},{key:"start",value:function(t){this.setConfig(t),this.open(!1)}},{key:"open",value:function(t){var e=this;if(this.active&&!this.io){try{this.io=new WebSocket(this.url,this.protocols)}catch(t){throw this.emit("error",t),t}if(t){if(this.maxReconnectAttempts&&this.reconnectAttempts>this.maxReconnectAttempts)return}else this.reconnectAttempts=0;var n,o,i;this.emit("connecting"),l("attempt-connect",this),this.timeId=setTimeout(function(){l("connection-timeout",e),e.timeoutClosed=!0,e.io.close(),e.timeoutClosed=!1},this.timeoutInterval),n=this,o=this.io,i=t,o.onopen=function(t){clearTimeout(n.timeId),l("open",n),this.reconnectAttempts=0,n.protocol=o.protocol,n.emit("open",t),n.flush()},o.onclose=function(t){if(clearTimeout(n.timeId),n.io=null,n.forcedClose)n.emit("close",t),n.active||(n._events={});else{if(i||n.timeoutClosed||n.emit("close",t),!n.automaticReconnect)return;var e=n.reconnectInterval*Math.pow(n.reconnectDecay,n.reconnectAttempts);setTimeout(function(){n.reconnectAttempts++,n.open(!0)},e>n.maxReconnectInterval?n.maxReconnectInterval:e)}},o.onmessage=function(t){if(l("onmessage: ",t.data,n),n.emit("message",t.data),"string"==typeof t.data)try{var e=JSON.parse(t.data);e.type&&n.emit(e.type,e.payload)}catch(t){l("onmessage: 解析失败，接受的数据不是json格式",n)}},o.onerror=function(t){l("onerror: ",t,n),n.emit("error",t)}}}},{key:"send",value:function(t){if(1===this.readyState)return l("send data: ",t,this),this.io.send(t);console.error("WebSocket实例不存在，请尝试重新连接")}},{key:"write",value:function(t,e){return 1===this.readyState?(this.send(JSON.stringify({type:t,payload:e})),0):this.active?(this.polls.push(JSON.stringify({type:t,payload:e})),this.polls.length):-1}},{key:"flush",value:function(){for(var t=this.polls,e=0,n=t.length;e<n;e++)this.send(t[e]);this.polls=[]}},{key:"close",value:function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1e3;this.active&&(this.forcedClose=!0,this.io&&this.io.close(e,t))}},{key:"destroy",value:function(){this.active&&(this.active=!1,this.close("destroy"))}},{key:"readyState",get:function(){if(this.io)return this.io.readyState}}]),i}();function l(){for(var t=arguments.length,e=Array(t),n=0;n<t;n++)e[n]=arguments[n];if(e[e.length-1].debug){var o,r=e.slice(0,e.length-1);(o=console).log.apply(o,i(r))}}var p=Object.prototype,h=function(t){return p.toString.call(t)};function y(e){if(null==(n=e)||"object"!==(void 0===n?"undefined":t(n))||"[object Object]"!==h(e))return!1;var n,o=Object.getPrototypeOf(e);return null===o||o.constructor===Object}return f});
